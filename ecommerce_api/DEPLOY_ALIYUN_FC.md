# 阿里云函数计算部署指南

## 问题分析

根据测试结果，我们发现原始部署存在以下问题：

1. **编码问题**：阿里云函数计算环境下出现`Non-ASCII character`错误
2. **资源限制**：原始代码加载大型Transformer模型，超出阿里云函数计算的资源限制
3. **环境配置**：启动脚本与应用模块的配置不匹配

## 解决方案

我已经为您创建了一个轻量级版本的API服务`simple_server.py`，它：
- 移除了大型模型依赖
- 使用最小化的依赖集
- 提供模拟的产品描述生成功能
- 修复了编码问题
- 在本地环境测试通过

## 部署准备

### 1. 准备部署文件

确保您有以下文件：
- `simple_server.py` - 轻量级API服务器（已创建）
- `requirements_simple.txt` - 最小化依赖列表（已创建）
- 可选：`.env` - 环境变量配置文件

### 2. 修改阿里云函数计算配置

登录阿里云函数计算控制台，按照以下步骤配置：

1. **函数配置**：
   - 入口函数：改为`simple_server`（注意不需要.py后缀）
   - 环境变量：设置`APP_HOST=0.0.0.0`和`APP_PORT=8000`
   - 内存配置：建议至少设置为256MB
   - 超时时间：建议设置为60秒

2. **依赖管理**：
   - 使用`requirements_simple.txt`替代原来的`requirements.txt`
   - 确保依赖安装方式选择"在线安装依赖"或"使用自定义镜像"

## 部署步骤

1. **上传代码**：
   - 选择"上传代码包"或"在线编辑代码"
   - 上传`simple_server.py`和`requirements_simple.txt`文件

2. **配置服务**：
   - 确认触发器配置（HTTP触发器）
   - 检查安全配置（根据需要设置认证方式）

3. **部署函数**：
   - 点击"部署"按钮，等待部署完成
   - 查看部署日志，确认是否成功

## 测试方法

使用我创建的测试脚本`test_aliyun_simple.py`来验证部署是否成功：

```bash
python test_aliyun_simple.py
```

该脚本会测试两个端点：
- `/health` - 健康检查端点
- `/generate-description` - 产品描述生成端点

## 常见问题排查

1. **部署失败**：
   - 检查函数计算日志，查看具体错误信息
   - 确认依赖安装是否成功
   - 验证入口文件和函数名是否正确

2. **资源超限**：
   - 增加函数计算的内存配额
   - 优化代码，减少资源消耗

3. **超时问题**：
   - 增加函数计算的超时时间配置
   - 优化API响应速度

4. **编码错误**：
   - 确保所有Python文件都包含UTF-8编码声明
   - 避免在代码注释中使用非ASCII字符

## 后续优化建议

1. **恢复模型功能**：
   - 如果需要真实的产品描述生成功能，可以考虑：
     - 使用轻量级模型（如TinyBERT）
     - 将模型部署到独立的模型服务，API服务通过网络调用
     - 使用阿里云的ModelArts服务承载模型推理

2. **监控与日志**：
   - 配置阿里云日志服务，收集API请求日志
   - 设置监控告警，及时发现服务异常

3. **性能优化**：
   - 实现请求缓存，减少重复计算
   - 使用异步处理，提高并发能力

4. **安全加固**：
   - 为API添加身份验证和授权机制
   - 设置请求频率限制，防止滥用

## 完整工作流程

1. 准备部署文件（`simple_server.py`和`requirements_simple.txt`）
2. 在阿里云函数计算控制台配置函数
3. 部署函数代码
4. 使用测试脚本验证部署结果
5. 根据需要进行后续优化

现在您可以按照这个指南在阿里云函数计算上成功部署API服务了！